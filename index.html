<!doctype html>
<html>
    <head>
        <title>HDR Image Merger</title>
        <style>
            body {
                font-family: system-ui, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .dropzone {
                border: 2px dashed #ccc;
                border-radius: 4px;
                padding: 20px;
                text-align: center;
                margin: 20px 0;
                cursor: pointer;
            }
            .dropzone.dragover {
                background: #f0f0f0;
                border-color: #666;
            }
            .preview {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
                margin: 20px 0;
            }
            .preview-item {
                position: relative;
            }
            .preview-item img {
                width: 100%;
                height: auto;
                display: block;
            }
            .preview-info {
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 8px;
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                font-size: 12px;
            }
            #result {
                max-width: 100%;
                height: auto;
            }
            .button {
                background: #0066cc;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
            }
            .button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
        </style>
    </head>
    <body>
        <h1>HDR Image Merger</h1>
        <p>
            Upload multiple images with different exposures to create an HDR
            image. Images should be taken with exposure bracketing (e.g., -2EV,
            0EV, +2EV).
        </p>

        <div class="dropzone" id="dropzone">
            <p>Drag & drop images here or click to select files</p>
            <input
                type="file"
                id="fileInput"
                multiple
                accept="image/*"
                style="display: none"
            />
        </div>

        <div class="preview" id="preview"></div>

        <button id="process" class="button" disabled>Process HDR</button>

        <h2>Result:</h2>
        <img id="result" />

        <script type="module">
            import init, { HdrProcessor } from "./pkg/hdr_web_app.js";

            let hdrProcessor;
            let uploadedFiles = [];

            async function initialize() {
                await init();
                hdrProcessor = new HdrProcessor();
                setupUI();
            }

            function setupUI() {
                const dropzone = document.getElementById("dropzone");
                const fileInput = document.getElementById("fileInput");
                const processButton = document.getElementById("process");

                dropzone.addEventListener("click", () => fileInput.click());
                dropzone.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    dropzone.classList.add("dragover");
                });
                dropzone.addEventListener("dragleave", () => {
                    dropzone.classList.remove("dragover");
                });
                dropzone.addEventListener("drop", handleDrop);
                fileInput.addEventListener("change", handleFileSelect);
                processButton.addEventListener("click", processHDR);
            }

            async function handleDrop(e) {
                e.preventDefault();
                const dropzone = document.getElementById("dropzone");
                dropzone.classList.remove("dragover");

                const files = [...e.dataTransfer.files].filter((f) =>
                    f.type.startsWith("image/"),
                );
                await handleFiles(files);
            }

            async function handleFileSelect(e) {
                const files = [...e.target.files].filter((f) =>
                    f.type.startsWith("image/"),
                );
                await handleFiles(files);
            }

            function formatExposureInfo(info) {
                const parts = [];
                parts.push(`Exposure: ${info.exposure_time}`);
                if (info.iso) parts.push(`ISO: ${info.iso}`);
                if (info.exposure_bias !== null)
                    parts.push(`Bias: ${info.exposure_bias}EV`);
                return parts.join(" | ");
            }

            async function handleFiles(files) {
                uploadedFiles = [...uploadedFiles, ...files];
                document.getElementById("process").disabled =
                    uploadedFiles.length < 2;

                const preview = document.getElementById("preview");

                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const info = await hdrProcessor.add_image(
                                e.target.result,
                            );

                            const container = document.createElement("div");
                            container.className = "preview-item";

                            const img = document.createElement("img");
                            img.src = e.target.result;
                            container.appendChild(img);

                            const infoDiv = document.createElement("div");
                            infoDiv.className = "preview-info";
                            infoDiv.textContent = formatExposureInfo(info);
                            container.appendChild(infoDiv);

                            preview.appendChild(container);
                        } catch (error) {
                            console.error("Error adding image:", error);
                            alert("Error adding image: " + error);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }

            async function processHDR() {
                const processButton = document.getElementById("process");
                processButton.disabled = true;
                processButton.textContent = "Processing...";

                try {
                    const result = await hdrProcessor.process_hdr();
                    document.getElementById("result").src = result;
                } catch (error) {
                    console.error("Error processing HDR:", error);
                    alert("Error processing HDR: " + error);
                } finally {
                    processButton.disabled = false;
                    processButton.textContent = "Process HDR";
                }
            }

            initialize().catch(console.error);
        </script>
    </body>
</html>
